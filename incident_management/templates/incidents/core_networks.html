{% extends 'base/base.html' %}
{% load incident_tags %}

{% block title %}Core Networks{% endblock %}

{% block extra_css %}
<style>
/* Modern Dashboard Design */
:root {
  --surface-primary: #ffffff;
  --surface-secondary: #f8fafc;
  --surface-tertiary: #f1f5f9;
  --border-light: #e2e8f0;
  --border-medium: #cbd5e1;
  --text-primary: #0f172a;
  --text-secondary: #475569;
  --text-muted: #64748b;
  --radius-sm: 6px;
  --radius-md: 8px;
  --radius-lg: 12px;
  --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
  --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
  --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
}

/* Compact Severity Legend */
.severity-legend {
  background: var(--surface-primary);
  border: 1px solid var(--border-light);
  border-radius: var(--radius-md);
  padding: 12px 16px;
  margin-bottom: 24px;
  box-shadow: var(--shadow-sm);
}

.severity-legend-content {
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 16px;
}

.severity-legend-title {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-secondary);
  margin-right: 8px;
  white-space: nowrap;
}

.severity-item {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  color: var(--text-muted);
}

.severity-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}

.severity-dot.new { background: #64748b; }
.severity-dot.low { background: #f59e0b; }
.severity-dot.medium { background: #ea580c; }
.severity-dot.critical { background: #dc2626; }
.severity-dot.resolved { background: #16a34a; }

/* Header Section */
.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  gap: 24px;
}

.page-title {
  font-size: 24px;
  font-weight: 700;
  color: var(--text-primary);
  margin: 0;
  display: flex;
  align-items: center;
  gap: 8px;
}

.page-subtitle {
  font-size: 14px;
  color: var(--text-muted);
  margin: 2px 0 0 0;
}

/* Modern Stats Grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}

.stat-card {
  background: var(--surface-primary);
  border: 1px solid var(--border-light);
  border-radius: var(--radius-md);
  padding: 20px;
  box-shadow: var(--shadow-sm);
  transition: all 0.2s ease;
  position: relative;
  overflow: hidden;
}

.stat-card:hover {
  box-shadow: var(--shadow-md);
  border-color: var(--border-medium);
}

.stat-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 3px;
  background: var(--accent-color, #64748b);
}

.stat-card.danger::before { background: #dc2626; }
.stat-card.success::before { background: #16a34a; }
.stat-card.warning::before { background: #ea580c; }
.stat-card.info::before { background: #f59e0b; }

.stat-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 8px;
}

.stat-number {
  font-size: 28px;
  font-weight: 800;
  color: var(--text-primary);
  line-height: 1;
}

.stat-label {
  font-size: 13px;
  font-weight: 500;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.025em;
}

.stat-icon {
  width: 20px;
  height: 20px;
  opacity: 0.6;
}

/* Modern Table */
.incidents-container {
  background: var(--surface-primary);
  border: 1px solid var(--border-light);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-sm);
  overflow: hidden;
}

.table-header {
  background: var(--surface-secondary);
  border-bottom: 1px solid var(--border-light);
  padding: 20px 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.table-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--text-primary);
  margin: 0;
  display: flex;
  align-items: center;
  gap: 10px;
}

.table-count {
  background: #3b82f6;
  color: white;
  padding: 4px 12px;
  border-radius: 16px;
  font-size: 13px;
  font-weight: 600;
  min-width: 24px;
  text-align: center;
}

/* Table Styling */
.modern-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
}

.modern-table thead th {
  background: var(--surface-secondary);
  border-bottom: 1px solid var(--border-light);
  padding: 16px 20px;
  text-align: left;
  font-size: 12px;
  font-weight: 600;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.025em;
  white-space: nowrap;
}

.modern-table tbody td {
  padding: 20px;
  border-bottom: 1px solid var(--border-light);
  vertical-align: middle;
  font-size: 14px;
  background: var(--surface-primary);
}

.modern-table tbody tr:last-child td {
  border-bottom: none;
}

.modern-table tbody tr:hover td {
  background: var(--surface-secondary);
}

/* Clean Row Styling - No Background Colors */
.modern-table tbody tr td:first-child {
  border-left: 4px solid #e2e8f0;
}

.incident-new td:first-child {
  border-left-color: #64748b;
}

.incident-low td:first-child {
  border-left-color: #f59e0b;
}

.incident-medium td:first-child {
  border-left-color: #ea580c;
}

.incident-critical td:first-child {
  border-left-color: #dc2626;
}

.incident-resolved td:first-child {
  border-left-color: #16a34a;
}

/* Severity Row Styling - Border Accent Only */
.incident-new,
.incident-low,
.incident-medium,
.incident-critical,
.incident-resolved {
  /* Color indication handled by first-child border only */
}

/* Status Column */
.status-cell {
  display: flex;
  align-items: center;
  gap: 10px;
  min-width: 90px;
}

.status-indicator {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  flex-shrink: 0;
}

.status-icon {
  font-size: 16px;
  opacity: 0.8;
}

.status-icon.critical { color: #dc2626; }
.status-icon.medium { color: #ea580c; }
.status-icon.low { color: #f59e0b; }
.status-icon.new { color: #64748b; }
.status-icon.resolved { color: #16a34a; }

/* Incident ID */
.incident-id {
  font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
  font-size: 13px;
  font-weight: 500;
  color: var(--text-primary);
  background: var(--surface-tertiary);
  padding: 2px 6px;
  border-radius: 4px;
}

/* Severity Badge */
.severity-badge {
  display: inline-flex;
  align-items: center;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.025em;
}

.severity-badge.new {
  background: #f1f5f9;
  color: #475569;
}

.severity-badge.low {
  background: #fef3c7;
  color: #92400e;
}

.severity-badge.medium {
  background: #fed7aa;
  color: #c2410c;
}

.severity-badge.critical {
  background: #fecaca;
  color: #b91c1c;
}

.severity-badge.resolved {
  background: #dcfce7;
  color: #166534;
}

/* Archive Status Badges */
.badge.bg-success {
  animation: pulse-success 2s infinite;
}

@keyframes pulse-success {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

.badge[title] {
  cursor: help;
}

/* Duration Display */
.duration-display {
  font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
  font-size: 13px;
  font-weight: 500;
  background: var(--surface-tertiary);
  color: var(--text-primary);
  padding: 2px 6px;
  border-radius: 4px;
}


/* Extremities Display */
.extremities-info {
  font-size: 12px;
  line-height: 1.3;
  color: var(--text-muted);
}

.extremities-info strong {
  color: var(--text-secondary);
}

/* Action Buttons */
.action-buttons {
  display: flex;
  gap: 4px;
}

.action-btn {
  width: 28px;
  height: 28px;
  border: 1px solid var(--border-light);
  border-radius: var(--radius-sm);
  background: var(--surface-primary);
  color: var(--text-secondary);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  transition: all 0.15s ease;
  cursor: pointer;
}

.action-btn:hover {
  background: var(--surface-secondary);
  border-color: var(--border-medium);
  transform: translateY(-1px);
}

.action-btn.primary {
  background: #3b82f6;
  border-color: #3b82f6;
  color: white;
}

.action-btn.primary:hover {
  background: #2563eb;
  border-color: #2563eb;
}

/* Empty State */
.empty-state {
  text-align: center;
  padding: 48px 24px;
  background: var(--surface-primary);
  border: 1px solid var(--border-light);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-sm);
}

.empty-icon {
  font-size: 48px;
  color: #16a34a;
  margin-bottom: 16px;
}

.empty-title {
  font-size: 18px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 8px;
}

.empty-subtitle {
  font-size: 14px;
  color: var(--text-muted);
  margin-bottom: 20px;
}

/* Primary Button */
.btn-primary-modern {
  background: #3b82f6;
  border: 1px solid #3b82f6;
  color: white;
  padding: 8px 16px;
  border-radius: var(--radius-md);
  font-size: 14px;
  font-weight: 500;
  transition: all 0.15s ease;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  text-decoration: none;
}

.btn-primary-modern:hover {
  background: #2563eb;
  border-color: #2563eb;
  color: white;
  transform: translateY(-1px);
  box-shadow: var(--shadow-md);
}

/* Responsive Design */
@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
  }
  
  .stat-card {
    padding: 16px;
  }
  
  .stat-number {
    font-size: 24px;
  }
  
  .page-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 16px;
  }
  
  .severity-legend-content {
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
  }
  
  .modern-table {
    font-size: 12px;
  }
  
  .modern-table tbody td {
    padding: 12px 8px;
  }
}

/* Search Interface Styles */
.search-filter-container {
  background: var(--surface-primary);
  border: 1px solid var(--border-light);
  border-radius: var(--radius-lg);
  margin-bottom: 24px;
  box-shadow: var(--shadow-sm);
  overflow: hidden;
}

.search-header {
  background: var(--surface-secondary);
  border-bottom: 1px solid var(--border-light);
  padding: 16px 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.search-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--text-primary);
  margin: 0;
  display: flex;
  align-items: center;
  gap: 8px;
}

.search-results-info {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
  color: var(--text-secondary);
}

.results-badge {
  background: #10b981;
  color: white;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
}

.search-form {
  padding: 24px;
}

.search-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 20px;
  margin-bottom: 20px;
}

.date-range-field {
  grid-column: span 2;
}

.search-field {
  display: flex;
  flex-direction: column;
}

.search-label {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-secondary);
  margin-bottom: 6px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.search-field input,
.search-field select {
  border: 1px solid var(--border-light);
  border-radius: var(--radius-sm);
  padding: 8px 12px;
  font-size: 14px;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

.search-field input:focus,
.search-field select:focus {
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  outline: none;
}

.search-help {
  font-size: 11px;
  color: var(--text-muted);
  margin-top: 4px;
}

.date-range-inputs {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

.date-input-group {
  display: flex;
  flex-direction: column;
}

.date-input-group small {
  font-size: 11px;
  color: var(--text-muted);
  margin-bottom: 4px;
}

.advanced-filters {
  border-top: 1px solid var(--border-light);
  padding-top: 16px;
  margin-top: 20px;
}

.advanced-toggle {
  color: var(--text-secondary);
  text-decoration: none;
  font-size: 14px;
  padding: 0;
  border: none;
  background: none;
}

.advanced-toggle:hover {
  color: var(--text-primary);
}

.advanced-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-top: 16px;
}

.search-actions {
  display: flex;
  gap: 12px;
  align-items: center;
  margin-top: 20px;
  padding-top: 20px;
  border-top: 1px solid var(--border-light);
}

.search-help-panel {
  margin-top: 16px;
  padding: 16px;
  background: var(--surface-tertiary);
  border-radius: var(--radius-sm);
  border: 1px solid var(--border-light);
}

.search-help-content h6 {
  color: var(--text-primary);
  margin-bottom: 12px;
}

.search-help-content ul {
  margin: 0;
  padding-left: 20px;
}

.search-help-content li {
  margin-bottom: 4px;
  font-size: 13px;
  color: var(--text-secondary);
}

/* Responsive Design */
@media (max-width: 768px) {
  .search-grid {
    grid-template-columns: 1fr;
  }
  
  .date-range-field {
    grid-column: span 1;
  }
  
  .date-range-inputs {
    grid-template-columns: 1fr;
  }
  
  .advanced-grid {
    grid-template-columns: 1fr;
  }
  
  .search-actions {
    flex-wrap: wrap;
    gap: 8px;
  }
  
  .search-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
  }
}

.search-header.clickable {
  cursor: pointer;
  transition: background-color 0.2s ease;
}

.search-header.clickable:hover {
  background: #f1f5f9;
}

.search-toggle-icon {
  transition: transform 0.3s ease;
  margin-right: 8px;
  font-size: 14px;
}

/* Rotate arrow when expanded */
.search-header[aria-expanded="true"] .search-toggle-icon {
  transform: rotate(90deg);
}

/* Prevent row click when clicking checkbox */
.checkbox-cell {
  pointer-events: auto;
}

.checkbox-cell input {
  cursor: pointer;
}

/* Auto-expand if search is active */
{% if search_active %}
#searchContainer {
  display: block !important;
}
{% endif %}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- Compact Severity Legend -->
  <div class="severity-legend">
    <div class="severity-legend-content">
      <span class="severity-legend-title">Status:</span>
      <div class="severity-item">
        <div class="severity-dot new"></div>
        <span>New (&lt;1h)</span>
      </div>
      <div class="severity-item">
        <div class="severity-dot low"></div>
        <span>Low (1-2h)</span>
      </div>
      <div class="severity-item">
        <div class="severity-dot medium"></div>
        <span>Medium (2-4h)</span>
      </div>
      <div class="severity-item">
        <div class="severity-dot critical"></div>
        <span>Critical (>4h)</span>
      </div>
      <div class="severity-item">
        <div class="severity-dot resolved"></div>
        <span>Resolved</span>
      </div>
    </div>
  </div>

  <!-- Page Header -->
  <div class="page-header">
    <div style="flex-grow: 1;">
      <h1 class="page-title">
        <i class="bi bi-cpu" style="color: #3b82f6;"></i>
        Core Networks
      </h1>
      <p class="page-subtitle">Monitor and manage core network incidents</p>
    </div>
    <div style="margin-left: auto;">
      <a href="{% url 'incidents:add_core_incident' %}" class="btn-primary-modern">
        <i class="bi bi-plus-circle"></i>
        Add New Incident
      </a>
    </div>
  </div>

<!-- Collapsible Search and Filter Interface -->
  {% if search_form %}
  <div class="search-filter-container">
    <div class="search-header clickable" data-bs-toggle="collapse" data-bs-target="#searchContainer" aria-expanded="false">
      <h3 class="search-title">
        <i class="bi bi-chevron-right search-toggle-icon"></i>
        <i class="bi bi-funnel"></i>
        Search & Filter
      </h3>
      {% if search_active %}
      <div class="search-results-info">
        <span class="results-badge">{{ search_stats.filtered_incidents }}</span> 
        of {{ search_stats.total_incidents }} incidents
        <a href="?" class="btn btn-outline-secondary btn-sm ms-2">
          <i class="bi bi-x-circle"></i> Clear Filters
        </a>
      </div>
      {% endif %}
    </div>
    
    <div class="collapse" id="searchContainer">
      <!-- Saved Searches Section -->
      <div class="saved-searches-section" style="padding: 16px 24px; border-bottom: 1px solid var(--border-light); background: var(--surface-tertiary);">
        <div class="row align-items-center">
          <div class="col-md-8">
            <label class="form-label mb-2 fw-semibold" style="font-size: 13px; color: var(--text-secondary);">
              <i class="bi bi-bookmark"></i> Quick Load Saved Search
            </label>
            <select class="form-select" id="savedSearchSelect" style="max-width: 400px;">
              <option value="">-- Select a saved search --</option>
            </select>
          </div>
          <div class="col-md-4 text-end">
            <button type="button" class="btn btn-sm btn-outline-primary" id="manageSearchesBtn">
              <i class="bi bi-gear"></i> Manage Searches
            </button>
          </div>
        </div>
      </div>

      <form method="get" class="search-form" id="searchForm">
        <div class="search-grid">
          <!-- Text Search -->
          <div class="search-field">
            <label class="search-label">
              <i class="bi bi-search"></i> Search Text
            </label>
            {{ search_form.search_query }}
            <small class="search-help">Search by ID, location, comments, cause, or origin</small>
          </div>
          
          <!-- Status Filter -->
          <div class="search-field">
            <label class="search-label">
              <i class="bi bi-funnel"></i> Status
            </label>
            {{ search_form.status }}
          </div>
          
          <!-- NETWORK-SPECIFIC SECTION - Change this part for each network -->
          <!-- FOR CORE NETWORKS: -->
          <div class="search-field">
            <label class="search-label">
              <i class="bi bi-server"></i> Platform
            </label>
            {{ search_form.platform }}
          </div>
          
          <div class="search-field">
            <label class="search-label">
              <i class="bi bi-diagram-3"></i> Region/Node
            </label>
            {{ search_form.region_node }}
          </div>
          
          <div class="search-field">
            <label class="search-label">
              <i class="bi bi-house"></i> Site
            </label>
            {{ search_form.site }}
          </div>
          <!-- END FILE ACCESS SPECIFIC FIELDS -->
          
          <!-- Date Range -->
          <div class="search-field date-range-field">
            <label class="search-label">
              <i class="bi bi-calendar-range"></i> Date Range
            </label>
            <div class="date-range-inputs">
              <div class="date-input-group">
                <small>From:</small>
                {{ search_form.date_from }}
              </div>
              <div class="date-input-group">
                <small>To:</small>
                {{ search_form.date_to }}
              </div>
            </div>
          </div>
        </div>
        
        <!-- Advanced Filters (Collapsible) -->
        <div class="advanced-filters">
          <button type="button" class="btn btn-link advanced-toggle" data-bs-toggle="collapse" data-bs-target="#advancedFilters">
            <i class="bi bi-chevron-down"></i> Advanced Filters
          </button>
          
          <div class="collapse" id="advancedFilters">
            <div class="advanced-grid">
              <div class="search-field">
                <label class="search-label">Cause</label>
                {{ search_form.cause }}
              </div>
              
              <div class="search-field">
                <label class="search-label">Origin</label>
                {{ search_form.origin }}
              </div>
              
              <div class="search-field">
                <label class="search-label">Sort By</label>
                {{ search_form.sort_by }}
              </div>
            </div>
          </div>
        </div>
        
        <!-- Search Actions -->
        <div class="search-actions">
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-search"></i> Apply Filters
          </button>
          <a href="?" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-clockwise"></i> Reset
          </a>
          <button type="button" class="btn btn-outline-info" onclick="toggleSearchHelp()">
            <i class="bi bi-question-circle"></i> Help
          </button>
          <button type="button" class="btn btn-success" id="saveSearchBtn">
            <i class="bi bi-bookmark-plus"></i> Save This Search
          </button>
        </div>
        
        <!-- Search Help (Hidden by default) -->
        <div class="search-help-panel" id="searchHelp" style="display: none;">
          <div class="search-help-content">
            <h6><i class="bi bi-lightbulb"></i> Search Tips</h6>
            <ul>
              <li><strong>Text Search:</strong> Search incident IDs, locations, comments, causes, or origins</li>
              <li><strong>Status Filter:</strong> Filter by incident severity (New, Low, Medium, Critical, Resolved)</li>
              <li><strong>Date Range:</strong> Filter incidents within specific time periods</li>
              <li><strong>Network Fields:</strong> Filter by specific network equipment or locations</li>
              <li><strong>Combine Filters:</strong> Use multiple filters together for precise results</li>
            </ul>
          </div>
        </div>
      </form>
    </div>
  </div>
  {% endif %}

  <!-- Modern Stats Grid -->
  <div class="stats-grid">
    <div class="stat-card danger">
      <div class="stat-header">
        <div>
          <div class="stat-number">{{ active_incidents|length }}</div>
          <div class="stat-label">Active</div>
        </div>
        <i class="bi bi-exclamation-triangle stat-icon" style="color: #dc2626;"></i>
      </div>
    </div>
    
    <div class="stat-card success">
      <div class="stat-header">
        <div>
          <div class="stat-number">{{ resolved_recent|length }}</div>
          <div class="stat-label">Resolved 24h</div>
        </div>
        <i class="bi bi-check-circle stat-icon" style="color: #16a34a;"></i>
      </div>
    </div>

    {% if active_incidents %}
      <div class="stat-card warning">
        <div class="stat-header">
          <div>
            <div class="stat-number">
              {% for incident in active_incidents %}
                {% if incident|severity_class == 'incident-medium' %}1{% endif %}
              {% empty %}0{% endfor %}
            </div>
            <div class="stat-label">Medium</div>
          </div>
          <i class="bi bi-exclamation-triangle-fill stat-icon" style="color: #ea580c;"></i>
        </div>
      </div>
      
      <div class="stat-card info">
        <div class="stat-header">
          <div>
            <div class="stat-number">
              {% for incident in active_incidents %}
                {% if incident|severity_class == 'incident-critical' %}1{% endif %}
              {% empty %}0{% endfor %}
            </div>
            <div class="stat-label">Critical</div>
          </div>
          <i class="bi bi-exclamation-octagon stat-icon" style="color: #dc2626;"></i>
        </div>
      </div>
    {% endif %}
  </div>

  <!-- Active Incidents Table -->
  {% if active_incidents %}
  <div class="incidents-container mb-4">
    <div class="table-header">
      <div class="d-flex justify-content-between align-items-center w-100">
        <div>
          <h2 class="table-title mb-0">
            <i class="bi bi-list-ul"></i>
            Active Incidents
          </h2>
        </div>
        <div class="d-flex align-items-center gap-3">
          <span class="table-count">{{ active_incidents|length }}</span>
          <button class="btn btn-sm btn-success export-incidents-btn" data-network-type="transport">
            <i class="bi bi-download me-1"></i>Export
          </button>
        </div>
      </div>
    </div>
    
    <table class="modern-table">
      <thead>
        <tr>
          <th>Status</th>
          <th>ID</th>
          <th>Platform</th>
          <th>Region/Node</th>
          <th>Site</th>
          <th>Extremities</th>
          <th>Started</th>
          <th>Duration</th>
          <th>Severity</th>
          {% if user.is_admin %}<th>Archive Status</th>{% endif %}
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for incident in active_incidents %}
        <tr class="{{ incident|severity_class }} incident-row" 
          data-incident-id="{{ incident.id }}" 
          data-network-type="core">
          <td>
            <div class="status-cell">
              <div class="status-indicator" style="background: 
                {% if incident|severity_class == 'incident-critical' %}#dc2626
                {% elif incident|severity_class == 'incident-medium' %}#ea580c
                {% elif incident|severity_class == 'incident-low' %}#f59e0b
                {% else %}#64748b{% endif %};"></div>
              {% if incident|severity_class == 'incident-critical' %}
                <i class="bi bi-exclamation-octagon-fill status-icon critical"></i>
              {% elif incident|severity_class == 'incident-medium' %}
                <i class="bi bi-exclamation-triangle-fill status-icon medium"></i>
              {% elif incident|severity_class == 'incident-low' %}
                <i class="bi bi-exclamation-triangle status-icon low"></i>
              {% else %}
                <i class="bi bi-circle status-icon new"></i>
              {% endif %}
            </div>
          </td>
          <td>
            <span class="incident-id">{{ incident.id|truncate_id }}</span>
          </td>
          <td>
            <span class="platform-badge">{{ incident.platform|default:"-" }}</span>
          </td>
          <td>
            <strong>{{ incident.region_node|default:"-" }}</strong>
          </td>
          <td>{{ incident.site|default:"-" }}</td>
          <td>
            {% if incident.extremity_a or incident.extremity_b %}
            <div class="extremities-info">
              <div><strong>A:</strong> {{ incident.extremity_a|truncatechars:15 }}</div>
              <div><strong>B:</strong> {{ incident.extremity_b|truncatechars:15 }}</div>
            </div>
            {% else %}
            <span class="text-muted">-</span>
            {% endif %}
          </td>
          <td>
            <div style="font-size: 13px;">
              {{ incident.date_time_incident|date:"M d, H:i" }}
              <br><span style="font-size: 11px; color: var(--text-muted);">{{ incident.date_time_incident|time_since }}</span>
            </div>
          </td>
          <td>
            <span class="duration-display">{{ incident|duration_display }}</span>
          </td>
          <td>
            <span class="severity-badge {{ incident|severity_class|slice:9 }}">
              {{ incident|severity_display }}
            </span>
          </td>
          {% if user.is_admin %}
          <td>
            {% if incident.date_time_recovery %}
              {% if incident.can_be_archived %}
                <span class="badge bg-success" title="Ready to archive - all criteria met">
                  <i class="bi bi-check-circle me-1"></i>Ready
                </span>
              {% else %}
                <span class="badge bg-secondary" title="Not yet eligible for archival">
                  <i class="bi bi-clock me-1"></i>
                  {% if not incident.cause %}No Cause{% elif not incident.origin %}No Origin{% else %}< 2hrs{% endif %}
                </span>
              {% endif %}
            {% else %}
              <span class="badge bg-light text-dark" title="Active incident">
                <i class="bi bi-dash"></i>
              </span>
            {% endif %}
          </td>
          {% endif %}
          <td>
            <div class="action-buttons">
              <a href="{% url 'incidents:edit_core_incident' incident.id %}"
                 class="action-btn primary" title="Edit">
                <i class="bi bi-pencil"></i>
              </a>
              <button class="action-btn" onclick="showIncidentDetails('{{ incident.id }}')"
                      title="View">
                <i class="bi bi-eye"></i>
              </button>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="empty-state">
    <i class="bi bi-check-circle-fill empty-icon"></i>
    <h3 class="empty-title">All Clear</h3>
    <p class="empty-subtitle">No active core network incidents at this time.</p>
    <a href="{% url 'incidents:add_core_incident' %}" class="btn-primary-modern">
      <i class="bi bi-plus-circle"></i>
      Report New Incident
    </a>
  </div>
  {% endif %}

  <!-- Recent Resolved Incidents -->
  {% if resolved_recent %}
<div class="incidents-container">
    <div class="table-header">
      <div class="d-flex justify-content-between align-items-center w-100">
        <div>
          <h2 class="table-title mb-0">
            <i class="bi bi-check-circle"></i>
            Recently Resolved
          </h2>
        </div>
      </div>
    </div>
    
    <table class="modern-table">
      <thead>
        <tr>
          {% if user.is_admin %}<th><input type="checkbox" class="form-check-input" id="selectAllIncidents"></th>{% endif %}
          <th>Status</th>
          <th>ID</th>
          <th>Platform</th>
          <th>Region/Node</th>
          <th>Started</th>
          <th>Resolved</th>
          <th>Duration</th>
          {% if user.is_admin %}<th>Archive Status</th>{% endif %}
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for incident in resolved_recent %}
        <tr class="incident-resolved incident-row" 
          data-incident-id="{{ incident.id }}" 
          data-network-type="core">
          {% if user.is_admin %}
          <td class="checkbox-cell">
            <input type="checkbox" class="form-check-input incident-checkbox" 
                  value="{{ incident.id }}" 
                  data-network-type="core">
          </td>
          {% endif %}
          <td>
            <div class="status-cell">
              <div class="status-indicator" style="background: #16a34a;"></div>
              <i class="bi bi-check-circle-fill status-icon resolved"></i>
            </div>
          </td>
          <td>
            <span class="incident-id">{{ incident.id|truncate_id }}</span>
          </td>
          <td>
            <span class="platform-badge">{{ incident.platform|default:"-" }}</span>
          </td>
          <td>
            <strong>{{ incident.region_node|default:"-" }}</strong>
          </td>
          <td>{{ incident.date_time_incident|date:"M d, H:i" }}</td>
          <td>{{ incident.date_time_recovery|date:"M d, H:i" }}</td>
          <td>
            <span class="duration-display">{{ incident.duration_minutes|format_duration }}</span>
          </td>
          {% if user.is_admin %}
          <td>
            {% if incident.can_be_archived %}
              <span class="badge bg-success" title="Ready to archive">
                <i class="bi bi-check-circle me-1"></i>Ready
              </span>
            {% else %}
              <span class="badge bg-warning text-dark" title="Waiting for 2-hour period or missing cause/origin">
                <i class="bi bi-hourglass-split me-1"></i>Pending
              </span>
            {% endif %}
          </td>
          {% endif %}
          <td>
            <div class="action-buttons">
              <button class="action-btn" onclick="showIncidentDetails('{{ incident.id }}')"
                      title="View">
                <i class="bi bi-eye"></i>
              </button>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}

  <!-- Enhanced Pagination -->
  {% if incidents %}
    {% include 'base/pagination.html' with page_obj=incidents %}
  {% endif %}
</div>

<!-- Include the incident detail modal -->
{% include 'incidents/incident_detail_modal.html' %}

<!-- Save Search Modal -->
<div class="modal fade" id="saveSearchModal" tabindex="-1" aria-labelledby="saveSearchModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="saveSearchModalLabel">
          <i class="bi bi-bookmark-plus me-2"></i>Save Current Search
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="saveSearchForm">
          <div class="mb-3">
            <label for="searchName" class="form-label fw-bold">
              <i class="bi bi-tag me-1"></i>Search Name <span class="text-danger">*</span>
            </label>
            <input type="text" class="form-control" id="searchName" required 
                   placeholder="e.g., Critical Transport Incidents" maxlength="100">
            <small class="text-muted">Give this search a descriptive name (max 100 characters)</small>
          </div>
          
          <div class="mb-3">
            <label for="searchDescription" class="form-label fw-bold">
              <i class="bi bi-chat-text me-1"></i>Description (Optional)
            </label>
            <textarea class="form-control" id="searchDescription" rows="2" 
                      placeholder="What does this search find?" maxlength="255"></textarea>
            <small class="text-muted">Optional description to help remember what this search does</small>
          </div>
          
          <div class="mb-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="setAsDefault">
              <label class="form-check-label" for="setAsDefault">
                <strong>Set as default search for this network</strong>
                <br><small class="text-muted">This search will load automatically when you visit this page</small>
              </label>
            </div>
          </div>
          
          <div class="alert alert-info mb-0">
            <i class="bi bi-info-circle me-2"></i>
            <strong>Current filters:</strong>
            <div id="searchFiltersSummary" class="mt-2" style="font-size: 13px;">
              <!-- Will be populated by JavaScript -->
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle me-1"></i>Cancel
        </button>
        <button type="button" class="btn btn-primary" id="confirmSaveSearchBtn">
          <i class="bi bi-bookmark-check me-1"></i>Save Search
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Manage Searches Modal -->
<div class="modal fade" id="manageSearchesModal" tabindex="-1" aria-labelledby="manageSearchesModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="manageSearchesModalLabel">
          <i class="bi bi-gear me-2"></i>Manage Saved Searches
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="savedSearchesList">
          <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Loading saved searches...</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle me-1"></i>Close
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Export Format Selection Modal -->
<div class="modal fade" id="exportFormatModal" tabindex="-1" aria-labelledby="exportFormatModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="exportFormatModalLabel">
          <i class="bi bi-download me-2"></i>Export Incidents
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <i class="bi bi-info-circle me-2"></i>
          <strong>Export current view:</strong> This will export all incidents matching your current filters and search criteria.
        </div>
        
        <div class="mb-3">
          <label class="form-label fw-bold">
            <i class="bi bi-file-earmark me-1"></i>Select Export Format
          </label>
          
          <div class="format-options">
            <div class="form-check mb-3 p-3 border rounded">
              <input class="form-check-input" type="radio" name="exportFormat" id="formatCsv" value="csv" checked>
              <label class="form-check-label w-100" for="formatCsv" style="cursor: pointer;">
                <div class="d-flex align-items-center justify-content-between">
                  <div>
                    <strong class="d-block">CSV (Comma-Separated Values)</strong>
                    <small class="text-muted">Compatible with Excel, Google Sheets, and text editors</small>
                  </div>
                  <i class="bi bi-file-earmark-text fs-3 text-success"></i>
                </div>
              </label>
            </div>
            
            <div class="form-check p-3 border rounded">
              <input class="form-check-input" type="radio" name="exportFormat" id="formatExcel" value="xlsx">
              <label class="form-check-label w-100" for="formatExcel" style="cursor: pointer;">
                <div class="d-flex align-items-center justify-content-between">
                  <div>
                    <strong class="d-block">Excel (.xlsx)</strong>
                    <small class="text-muted">Color-coded severity, formatted columns, freeze headers</small>
                  </div>
                  <i class="bi bi-file-earmark-spreadsheet fs-3 text-success"></i>
                </div>
              </label>
            </div>
          </div>
        </div>
        
        <div id="exportStats" class="alert alert-secondary">
          <strong>Ready to export:</strong>
          <span id="exportCount">0</span> incidents will be included in your export file.
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle me-1"></i>Cancel
        </button>
        <button type="button" class="btn btn-success" id="confirmExportBtn">
          <i class="bi bi-download me-1"></i>Download Export
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Export Loading Overlay -->
<div id="exportLoadingOverlay" class="d-none position-fixed top-0 start-0 w-100 h-100" 
     style="background: rgba(0,0,0,0.7); z-index: 9999;">
  <div class="position-absolute top-50 start-50 translate-middle text-center">
    <div class="spinner-border text-light mb-3" style="width: 4rem; height: 4rem;" role="status">
      <span class="visually-hidden">Exporting...</span>
    </div>
    <h4 class="text-white">Preparing Export...</h4>
    <p class="text-light">This may take a moment. Please wait.</p>
  </div>
</div>

{% endblock %}

{% block page_js %}
<script>
// Function to load incident details into modal
function loadIncidentDetail(networkType, incidentId) {
    console.log('Loading incident:', incidentId, 'for network:', networkType);
    
    const modalElement = document.getElementById('incidentDetailModal');
    const modal = new bootstrap.Modal(modalElement);
    modal.show();
    
    document.getElementById('incidentDetailContent').innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Loading incident details...</p>
        </div>
    `;
    
    document.getElementById('editIncidentBtn').style.display = 'none';
    
    fetch(`/incidents/${networkType}/detail/${incidentId}/`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        },
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            document.getElementById('incidentDetailContent').innerHTML = data.html;
            const editBtn = document.getElementById('editIncidentBtn');
            editBtn.style.display = 'inline-block';
            editBtn.href = data.edit_url;
            console.log('Incident details loaded successfully');
        } else {
            document.getElementById('incidentDetailContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    ${data.error || 'Failed to load incident details'}
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Error loading incident details:', error);
        document.getElementById('incidentDetailContent').innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle me-2"></i>
                Failed to load incident details. Please try again.
                <br><small class="text-muted">Error: ${error.message}</small>
            </div>
        `;
    });
}

function toggleSearchHelp() {
    const helpPanel = document.getElementById('searchHelp');
    helpPanel.style.display = helpPanel.style.display === 'none' ? 'block' : 'none';
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('Setting up incident row click handlers');
    
    // Incident row clicks
    const incidentRows = document.querySelectorAll('.incident-row');
    console.log('Found', incidentRows.length, 'incident rows');
    
    incidentRows.forEach(row => {
        row.style.cursor = 'pointer';
        
        row.addEventListener('click', function(e) {
            if (e.target.closest('.action-btn') || e.target.closest('a') || e.target.closest('.checkbox-cell')) {
                return;
            }
            
            const incidentId = this.getAttribute('data-incident-id');
            const networkType = this.getAttribute('data-network-type');
            
            if (incidentId && networkType) {
                console.log('Row clicked:', incidentId);
                loadIncidentDetail(networkType, incidentId);
            }
        });
    });
    
    // View button clicks
    const viewButtons = document.querySelectorAll('.action-btn[title="View"]');
    viewButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const row = this.closest('.incident-row');
            if (row) {
                const incidentId = row.getAttribute('data-incident-id');
                const networkType = row.getAttribute('data-network-type');
                
                if (incidentId && networkType) {
                    loadIncidentDetail(networkType, incidentId);
                }
            }
        });
    });
    
    // Search toggle
    const searchHeader = document.querySelector('.search-header.clickable');
    const searchContainer = document.getElementById('searchContainer');
    
    if (searchContainer && searchHeader) {
        searchContainer.addEventListener('shown.bs.collapse', function() {
            searchHeader.setAttribute('aria-expanded', 'true');
        });
        
        searchContainer.addEventListener('hidden.bs.collapse', function() {
            searchHeader.setAttribute('aria-expanded', 'false');
        });
        
        // Auto-expand if search is active
        const urlParams = new URLSearchParams(window.location.search);
        const hasSearchParams = Array.from(urlParams.keys()).some(key => 
            key !== 'page' && key !== 'size' && urlParams.get(key)
        );
        
        if (hasSearchParams) {
            const collapse = new bootstrap.Collapse(searchContainer, {show: true});
            searchHeader.setAttribute('aria-expanded', 'true');
        }
    }
    
    // Search form
    const form = document.getElementById('searchForm');
    if (form) {
        const selects = form.querySelectorAll('select');
        selects.forEach(select => {
            select.addEventListener('change', function() {
                // form.submit();
            });
        });
        
        const searchInput = form.querySelector('input[name="search_query"]');
        let searchTimeout;
        
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    // form.submit();
                }, 500);
            });
        }
    }
    
    // Keyboard navigation
    document.addEventListener('keydown', function(e) {
        if (document.activeElement.tagName.toLowerCase() === 'input' || 
            document.activeElement.tagName.toLowerCase() === 'select') {
            return;
        }
        
        if ((e.key === 'ArrowLeft' || e.key === 'p') && e.ctrlKey) {
            const prevLink = document.querySelector('.page-item:has(.page-link[aria-label="Previous page"]) .page-link');
            if (prevLink) {
                e.preventDefault();
                prevLink.click();
            }
        }
        
        if ((e.key === 'ArrowRight' || e.key === 'n') && e.ctrlKey) {
            const nextLink = document.querySelector('.page-item:has(.page-link[aria-label="Next page"]) .page-link');
            if (nextLink) {
                e.preventDefault();
                nextLink.click();
            }
        }
    });
    
    // Preload next page
    const nextPageLink = document.querySelector('.page-item:has(.page-link[aria-label="Next page"]) .page-link');
    if (nextPageLink) {
        const link = document.createElement('link');
        link.rel = 'prefetch';
        link.href = nextPageLink.href;
        document.head.appendChild(link);
    }
    
    // Bulk Archive Functionality
    const selectAllCheckbox = document.getElementById('selectAllIncidents');
    const bulkArchiveBtn = document.getElementById('bulkArchiveBtn');
    const selectedCountSpan = document.getElementById('selectedCount');
    
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.incident-checkbox:not(:disabled)');
            checkboxes.forEach(cb => cb.checked = this.checked);
            updateBulkArchiveButton();
        });
    }
    
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('incident-checkbox')) {
            updateBulkArchiveButton();
        }
    });
    
    function updateBulkArchiveButton() {
        const checkedBoxes = document.querySelectorAll('.incident-checkbox:checked');
        const count = checkedBoxes.length;
        
        if (selectedCountSpan) selectedCountSpan.textContent = count;
        if (bulkArchiveBtn) bulkArchiveBtn.disabled = count === 0;
        
        if (selectAllCheckbox) {
            const allCheckboxes = document.querySelectorAll('.incident-checkbox:not(:disabled)');
            selectAllCheckbox.checked = allCheckboxes.length > 0 && count === allCheckboxes.length;
        }
    }
    
    if (bulkArchiveBtn) {
        bulkArchiveBtn.addEventListener('click', function() {
            const checkedBoxes = document.querySelectorAll('.incident-checkbox:checked');
            const incidentIds = Array.from(checkedBoxes).map(cb => cb.value);
            const networkType = checkedBoxes[0]?.getAttribute('data-network-type');
            
            if (incidentIds.length === 0) return;
            
            if (confirm(`Archive ${incidentIds.length} incident(s)?\n\nThis will move them to historical archive.`)) {
                bulkArchiveIncidents(incidentIds, networkType);
            }
        });
    }
    
    async function bulkArchiveIncidents(incidentIds, networkType) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                         document.querySelector('meta[name="csrf-token"]')?.content;
        
        bulkArchiveBtn.disabled = true;
        bulkArchiveBtn.innerHTML = '<i class="bi bi-hourglass me-1"></i>Archiving...';
        
        try {
            const response = await fetch('/incidents/bulk-archive/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest',
                },
                body: JSON.stringify({
                    incident_ids: incidentIds,
                    network_type: networkType
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert(`Successfully archived ${data.archived_count} incident(s)!`);
                window.location.reload();
            } else {
                alert('Error: ' + (data.error || 'Failed to archive incidents'));
                bulkArchiveBtn.disabled = false;
                bulkArchiveBtn.innerHTML = '<i class="bi bi-archive me-1"></i>Archive Selected (<span id="selectedCount">0</span>)';
            }
        } catch (error) {
            console.error('Bulk archive error:', error);
            alert('Network error. Please try again.');
            bulkArchiveBtn.disabled = false;
            bulkArchiveBtn.innerHTML = '<i class="bi bi-archive me-1"></i>Archive Selected (<span id="selectedCount">0</span>)';
        }
    }
});

// ============================================================================
// SAVED SEARCH FUNCTIONALITY
// ============================================================================

const NETWORK_TYPE = 'core';
const savedSearchModule = {
    currentSearchParams: {},
    
    init() {
        this.loadSavedSearches();
        this.attachEventListeners();
        this.loadDefaultSearch();
    },
    
    attachEventListeners() {
        // Save search button
        document.getElementById('saveSearchBtn')?.addEventListener('click', () => {
            this.openSaveSearchModal();
        });
        
        // Confirm save button
        document.getElementById('confirmSaveSearchBtn')?.addEventListener('click', () => {
            this.saveSearch();
        });
        
        // Load saved search
        document.getElementById('savedSearchSelect')?.addEventListener('change', (e) => {
            if (e.target.value) {
                this.loadSearch(e.target.value);
            }
        });
        
        // Manage searches button
        document.getElementById('manageSearchesBtn')?.addEventListener('click', () => {
            this.openManageModal();
        });
    },
    
    async loadSavedSearches() {
        try {
            const response = await fetch(`/incidents/saved-search/${NETWORK_TYPE}/list/`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                this.populateSavedSearchDropdown(data.searches);
            }
        } catch (error) {
            console.error('Error loading saved searches:', error);
        }
    },
    
    populateSavedSearchDropdown(searches) {
        const select = document.getElementById('savedSearchSelect');
        if (!select) return;
        
        // Clear existing options except first
        select.innerHTML = '<option value="">-- Select a saved search --</option>';
        
        searches.forEach(search => {
            const option = document.createElement('option');
            option.value = search.id;
            option.textContent = search.name;
            if (search.is_default) {
                option.textContent += ' (Default)';
            }
            select.appendChild(option);
        });
    },
    
    getCurrentSearchParams() {
        const form = document.getElementById('searchForm');
        const formData = new FormData(form);
        const params = {};
        
        for (let [key, value] of formData.entries()) {
            if (value && value.trim() !== '') {
                params[key] = value;
            }
        }
        
        return params;
    },
    
    openSaveSearchModal() {
        this.currentSearchParams = this.getCurrentSearchParams();
        
        // Show filter summary
        const summaryDiv = document.getElementById('searchFiltersSummary');
        const summary = Object.entries(this.currentSearchParams)
            .map(([key, value]) => `<strong>${key}:</strong> ${value}`)
            .join('<br>') || '<em>No filters applied</em>';
        
        summaryDiv.innerHTML = summary;
        
        const modal = new bootstrap.Modal(document.getElementById('saveSearchModal'));
        modal.show();
    },
    
    async saveSearch() {
        const name = document.getElementById('searchName').value.trim();
        const description = document.getElementById('searchDescription').value.trim();
        const setAsDefault = document.getElementById('setAsDefault').checked;
        
        if (!name) {
            alert('Please enter a search name');
            return;
        }
        
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        
        try {
            const response = await fetch(`/incidents/saved-search/${NETWORK_TYPE}/save/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    name: name,
                    description: description,
                    params: this.currentSearchParams,
                    set_as_default: setAsDefault
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('saveSearchModal')).hide();
                
                // Reset form
                document.getElementById('saveSearchForm').reset();
                
                // Reload saved searches
                await this.loadSavedSearches();
                
                // Show success message
                this.showNotification(data.message, 'success');
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            console.error('Error saving search:', error);
            alert('Network error. Please try again.');
        }
    },
    
    async loadSearch(searchId) {
        try {
            const response = await fetch(`/incidents/saved-search/${searchId}/load/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                this.applySearchParams(data.search.params);
                this.showNotification(`Loaded search: ${data.search.name}`, 'info');
            } else {
                alert('Error loading search: ' + data.error);
            }
        } catch (error) {
            console.error('Error loading search:', error);
            alert('Network error. Please try again.');
        }
    },
    
    applySearchParams(params) {
        const form = document.getElementById('searchForm');
        
        // Clear all fields first
        form.reset();
        
        // Apply saved params
        Object.entries(params).forEach(([key, value]) => {
            const field = form.querySelector(`[name="${key}"]`);
            if (field) {
                field.value = value;
            }
        });
        
        // Submit form to apply filters
        form.submit();
    },
    
    async loadDefaultSearch() {
        try {
            const response = await fetch(`/incidents/saved-search/${NETWORK_TYPE}/list/`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                const defaultSearch = data.searches.find(s => s.is_default);
                if (defaultSearch && !window.location.search) {
                    // Only apply default if no current search
                    this.applySearchParams(defaultSearch.params);
                }
            }
        } catch (error) {
            console.error('Error loading default search:', error);
        }
    },
    
    async openManageModal() {
        const modal = new bootstrap.Modal(document.getElementById('manageSearchesModal'));
        modal.show();
        
        await this.loadManageSearchesList();
    },
    
    async loadManageSearchesList() {
        const listDiv = document.getElementById('savedSearchesList');
        
        try {
            const response = await fetch(`/incidents/saved-search/${NETWORK_TYPE}/list/`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            const data = await response.json();
            
            if (data.success && data.searches.length > 0) {
                listDiv.innerHTML = data.searches.map(search => `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="card-title mb-1">
                                        ${search.name}
                                        ${search.is_default ? '<span class="badge bg-success ms-2">Default</span>' : ''}
                                    </h6>
                                    ${search.description ? `<p class="card-text text-muted small mb-2">${search.description}</p>` : ''}
                                    <p class="card-text small mb-1"><strong>Filters:</strong> ${search.params_summary}</p>
                                    <p class="card-text small text-muted mb-0">
                                        Used ${search.use_count} times
                                        ${search.last_used_at ? ` Last used: ${new Date(search.last_used_at).toLocaleDateString()}` : ''}
                                    </p>
                                </div>
                                <div class="btn-group-vertical ms-3">
                                    <button class="btn btn-sm btn-outline-primary" onclick="savedSearchModule.loadSearch('${search.id}')">
                                        <i class="bi bi-play-fill"></i> Load
                                    </button>
                                    ${!search.is_default ? `
                                    <button class="btn btn-sm btn-outline-secondary" onclick="savedSearchModule.setDefault('${search.id}')">
                                        <i class="bi bi-star"></i> Set Default
                                    </button>` : ''}
                                    <button class="btn btn-sm btn-outline-danger" onclick="savedSearchModule.deleteSearch('${search.id}', '${search.name}')">
                                        <i class="bi bi-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                listDiv.innerHTML = `
                    <div class="text-center py-4">
                        <i class="bi bi-bookmark" style="font-size: 48px; color: #6c757d;"></i>
                        <p class="mt-3 text-muted">No saved searches yet</p>
                        <p class="text-muted small">Save your current search to quickly access it later</p>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error loading searches list:', error);
            listDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Failed to load saved searches. Please try again.
                </div>
            `;
        }
    },
    
    async setDefault(searchId) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        
        try {
            const response = await fetch(`/incidents/saved-search/${searchId}/set-default/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                await this.loadManageSearchesList();
                await this.loadSavedSearches();
                this.showNotification(data.message, 'success');
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            console.error('Error setting default:', error);
            alert('Network error. Please try again.');
        }
    },
    
    async deleteSearch(searchId, searchName) {
        if (!confirm(`Delete saved search "${searchName}"?\n\nThis cannot be undone.`)) {
            return;
        }
        
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        
        try {
            const response = await fetch(`/incidents/saved-search/${searchId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                await this.loadManageSearchesList();
                await this.loadSavedSearches();
                this.showNotification(data.message, 'success');
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            console.error('Error deleting search:', error);
            alert('Network error. Please try again.');
        }
    },
    
    showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
        notification.style.zIndex = '9999';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => notification.remove(), 150);
        }, 3000);
    }
};

// Initialize saved search module when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    savedSearchModule.init();
});

// ============================================================================
// CSV/EXCEL EXPORT FUNCTIONALITY
// ============================================================================

const exportModule = {
    networkType: NETWORK_TYPE,
    currentSearchParams: {},
    
    init() {
        this.attachEventListeners();
        this.updateExportCount();
    },
    
    attachEventListeners() {
        // Export button click
        document.querySelectorAll('.export-incidents-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                this.openExportModal();
            });
        });
        
        // Confirm export button
        document.getElementById('confirmExportBtn')?.addEventListener('click', () => {
            this.performExport();
        });
    },
    
    getCurrentSearchParams() {
        const form = document.getElementById('searchForm');
        if (!form) return {};
        
        const formData = new FormData(form);
        const params = {};
        
        for (let [key, value] of formData.entries()) {
            if (value && value.trim() !== '') {
                params[key] = value;
            }
        }
        
        return params;
    },
    
    openExportModal() {
        this.currentSearchParams = this.getCurrentSearchParams();
        this.updateExportCount();
        
        const modal = new bootstrap.Modal(document.getElementById('exportFormatModal'));
        modal.show();
    },
    
    updateExportCount() {
        // Get current incident count from page
        const countElement = document.querySelector('.table-count');
        const count = countElement ? countElement.textContent.trim() : '0';
        
        const exportCountElement = document.getElementById('exportCount');
        if (exportCountElement) {
            exportCountElement.textContent = count;
        }
    },
    
    async performExport() {
        const selectedFormat = document.querySelector('input[name="exportFormat"]:checked').value;
        
        // Show loading overlay
        document.getElementById('exportLoadingOverlay').classList.remove('d-none');
        
        // Close modal
        bootstrap.Modal.getInstance(document.getElementById('exportFormatModal')).hide();
        
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        
        try {
            const response = await fetch(`/incidents/export/${this.networkType}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    format: selectedFormat,
                    search_params: this.currentSearchParams
                })
            });
            
            if (response.ok) {
                // Get filename from Content-Disposition header
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = `incidents_export.${selectedFormat}`;
                
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                    if (filenameMatch) {
                        filename = filenameMatch[1];
                    }
                }
                
                // Download file
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                this.showNotification(`Export successful! Downloaded ${filename}`, 'success');
            } else {
                const errorData = await response.json();
                this.showNotification(`Export failed: ${errorData.error || 'Unknown error'}`, 'danger');
            }
        } catch (error) {
            console.error('Export error:', error);
            this.showNotification('Network error during export. Please try again.', 'danger');
        } finally {
            // Hide loading overlay
            document.getElementById('exportLoadingOverlay').classList.add('d-none');
        }
    },
    
    showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
        notification.style.zIndex = '9999';
        notification.style.minWidth = '300px';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => notification.remove(), 150);
        }, 5000);
    }
};

// Initialize export module when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    exportModule.init();
});
</script>
{% endblock page_js %}