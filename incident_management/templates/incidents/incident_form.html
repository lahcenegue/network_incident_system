{% extends 'base/base.html' %}

{% block title %}{{ action }} {{ network_type }} Incident{% endblock %}

{% block extra_css %}
<style>
/* Professional form styling */
.form-section {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
}

.form-section h5 {
    color: #495057;
    border-bottom: 2px solid #007bff;
    padding-bottom: 8px;
    margin-bottom: 20px;
}

.required-field {
    color: #dc3545;
    font-weight: bold;
}

.form-control, .form-select {
    border: 1px solid #ced4da;
    border-radius: 6px;
    padding: 10px 12px;
    font-size: 14px;
}

.form-control:focus, .form-select:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

/* Enhanced datetime styling with calendar/clock icons */
.datetime-container {
    position: relative;
}

input[type="datetime-local"] {
    color-scheme: light;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    padding-right: 50px;
}

.datetime-container::before {
    content: "ðŸ“…";
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none;
    z-index: 1;
}

.btn-submit {
    background: linear-gradient(45deg, #007bff, #0056b3);
    border: none;
    padding: 12px 30px;
    border-radius: 6px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.btn-submit:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
}

.alert-info {
    background: linear-gradient(45deg, #d1ecf1, #bee5eb);
    border: 1px solid #b6d4db;
    color: #0c5460;
}

.network-icon {
    font-size: 1.2em;
    margin-right: 8px;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info">
                <h4 class="mb-2">
                    <i class="bi bi-plus-circle-fill me-2"></i>
                    {{ action }} Incident - {{ network_type }}
                </h4>
                <p class="mb-0">Complete all required fields marked with <span class="required-field">*</span> to create the incident record.</p>
            </div>
        </div>
    </div>

    <!-- Main Form -->
    <form method="post" id="incidentForm">
        {% csrf_token %}
        
        <!-- Network-Specific Section (First) -->
        {% if 'Transport' in network_type %}
            <!-- Transport Networks Form -->
            <div class="form-section">
                <h5><i class="bi bi-diagram-3 network-icon"></i>Transport Network Details</h5>
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">
                            Region / Loop <span class="required-field">*</span>
                        </label>
                        <select name="region_loop" class="form-select" required>
                            <option value="">--- Select Region/Loop ---</option>
                            {% for config in region_choices %}
                                <option value="{{ config.value }}" {% if form_data.region_loop == config.value %}selected{% endif %}>{{ config.value }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">
                            System / Capacity <span class="required-field">*</span>
                        </label>
                        <select name="system_capacity" class="form-select" required>
                            <option value="">--- Select System/Capacity ---</option>
                            {% for config in system_choices %}
                                <option value="{{ config.value }}" {% if form_data.system_capacity == config.value %}selected{% endif %}>{{ config.value }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0">Extremity A</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">DOT Extremity(A)</label>
                                    <select name="dot_extremity_a" class="form-select">
                                        <option value="">--- Select DOT State ---</option>
                                        {% for config in dot_choices %}
                                            <option value="{{ config.value }}">{{ config.value }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div>
                                    <label class="form-label fw-bold">
                                        Extremity(A) <span class="required-field">*</span>
                                    </label>
                                    <input type="text" name="extremity_a" class="form-control" 
                                        placeholder="Enter extremity A location" required
                                        value="{{ form_data.extremity_a|default:'' }}">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-warning">
                            <div class="card-header bg-warning text-dark">
                                <h6 class="mb-0">Extremity B</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">
                                        DOT Extremity(B) <span class="required-field">*</span>
                                    </label>
                                    <select name="dot_extremity_b" class="form-select" required>
                                        <option value="">--- Select DOT State ---</option>
                                        {% for config in dot_choices %}
                                            <option value="{{ config.value }}">{{ config.value }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div>
                                    <label class="form-label fw-bold">
                                        Extremity(B) <span class="required-field">*</span>
                                    </label>
                                    <input type="text" name="extremity_b" class="form-control" 
                                        placeholder="Enter extremity B location" required
                                        value="{{ form_data.extremity_b|default:'' }}">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <label class="form-label fw-bold">Responsibility</label>
                        <select name="responsibility" class="form-select">
                            <option value="">--- Select Responsibility ---</option>
                            <option value="A" {% if form_data.responsibility == 'A' %}selected{% endif %}>A</option>
                            <option value="B" {% if form_data.responsibility == 'B' %}selected{% endif %}>B</option>
                            <option value="Both" {% if form_data.responsibility == 'Both' %}selected{% endif %}>Both</option>
                        </select>
                        <small class="text-muted">Select responsibility assignment (optional)</small>
                    </div>
                </div>
            </div>
        {% elif 'File Access' in network_type %}
            <!-- File Access Networks Form -->
            <div class="form-section">
                <h5><i class="bi bi-hdd-network network-icon"></i>File Access Network Details</h5>
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">
                            DO / WILAYA <span class="required-field">*</span>
                        </label>
                        <select name="do_wilaya" class="form-select" required>
                            <option value="">--- Select Wilaya ---</option>
                            {% for config in wilaya_choices %}
                                <option value="{{ config.value }}">{{ config.value }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">
                            Zone / Metro <span class="required-field">*</span>
                        </label>
                        <input type="text" name="zone_metro" class="form-control" 
                               placeholder="Enter zone/metro area" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">
                            Site <span class="required-field">*</span>
                        </label>
                        <input type="text" name="site" class="form-control" 
                               placeholder="Enter site identification" required>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">
                            IP Address <span class="required-field">*</span>
                        </label>
                        <input type="text" name="ip_address" class="form-control" 
                               placeholder="Enter IP address (e.g., 192.168.1.1)" required>
                        <small class="text-muted">IPv4 or IPv6 address format</small>
                    </div>
                </div>
            </div>
        {% elif 'Radio Access' in network_type %}
            <!-- Radio Access Networks Form -->
            <div class="form-section">
                <h5><i class="bi bi-broadcast network-icon"></i>Radio Access Network Details</h5>
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">
                            DO / WILAYA <span class="required-field">*</span>
                        </label>
                        <select name="do_wilaya" class="form-select" required>
                            <option value="">--- Select Wilaya ---</option>
                            {% for config in wilaya_choices %}
                                <option value="{{ config.value }}">{{ config.value }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">
                            Site <span class="required-field">*</span>
                        </label>
                        <input type="text" name="site" class="form-control" 
                               placeholder="Enter site identification" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">
                            IP Address <span class="required-field">*</span>
                        </label>
                        <input type="text" name="ip_address" class="form-control" 
                               placeholder="Enter IP address (e.g., 192.168.1.1)" required>
                        <small class="text-muted">IPv4 or IPv6 address format</small>
                    </div>
                </div>
            </div>
        {% elif 'Core' in network_type %}
            <!-- Core Networks Form -->
            <div class="form-section">
                <h5><i class="bi bi-cpu network-icon"></i>Core Network Details</h5>
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">
                            Platform <span class="required-field">*</span>
                        </label>
                        <select name="platform" class="form-select" required>
                            <option value="">--- Select Platform ---</option>
                            {% for config in platform_choices %}
                                <option value="{{ config.value }}">{{ config.value }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">
                            Region / Node <span class="required-field">*</span>
                        </label>
                        <select name="region_node" class="form-select" required>
                            <option value="">--- Select Region/Node ---</option>
                            {% for config in region_node_choices %}
                                <option value="{{ config.value }}">{{ config.value }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Site</label>
                        <input type="text" name="site" class="form-control" 
                               placeholder="Enter site (optional)">
                    </div>
                </div>
                
                <!-- Optional Extremity Information for Core -->
                <div class="row mt-3">
                    <div class="col-12">
                        <h6 class="text-muted">Extremity Information (Optional)</h6>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-info">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0">Extremity A</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">DOT Extremity(A)</label>
                                    <select name="dot_extremity_a" class="form-select">
                                        <option value="">--- Select DOT State ---</option>
                                        {% for config in dot_choices %}
                                            <option value="{{ config.value }}">{{ config.value }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div>
                                    <label class="form-label">Extremity(A)</label>
                                    <input type="text" name="extremity_a" class="form-control" 
                                           placeholder="Enter extremity A location">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-warning">
                            <div class="card-header bg-warning text-dark">
                                <h6 class="mb-0">Extremity B</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">DOT Extremity(B)</label>
                                    <select name="dot_extremity_b" class="form-select">
                                        <option value="">--- Select DOT State ---</option>
                                        {% for config in dot_choices %}
                                            <option value="{{ config.value }}">{{ config.value }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div>
                                    <label class="form-label">Extremity(B)</label>
                                    <input type="text" name="extremity_b" class="form-control" 
                                           placeholder="Enter extremity B location">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% elif 'Backbone' in network_type %}
            <!-- Backbone Internet Networks Form -->
            <div class="form-section">
                <h5><i class="bi bi-globe network-icon"></i>Backbone Internet Network Details</h5>
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">
                            Interconnect Type <span class="required-field">*</span>
                        </label>
                        <select name="interconnect_type" class="form-select" required>
                            <option value="">--- Select Interconnect Type ---</option>
                            {% for config in interconnect_choices %}
                                <option value="{{ config.value }}">{{ config.value }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">
                            Platform/IGW <span class="required-field">*</span>
                        </label>
                        <select name="platform_igw" class="form-select" required>
                            <option value="">--- Select Platform/IGW ---</option>
                            {% for config in platform_igw_choices %}
                                <option value="{{ config.value }}">{{ config.value }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">
                            Link Label <span class="required-field">*</span>
                        </label>
                        <input type="text" name="link_label" class="form-control" 
                               placeholder="Enter link label" required>
                    </div>
                </div>
            </div>
        {% endif %}

        <!-- Timing Section (After Network Details) -->
        <div class="form-section">
            <h5><i class="bi bi-clock me-2"></i>Incident Timing</h5>
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label fw-bold">
                        Date and Time of Incident <span class="required-field">*</span>
                    </label>
                    <div class="datetime-container">
                        <input type="datetime-local" 
                               name="date_time_incident" 
                               class="form-control" 
                               required 
                               step="60"
                               value="{{ form.date_time_incident.value|default:'' }}">
                    </div>
                    <small class="text-muted">When did the incident occur?</small>
                </div>
                {% if action == 'Edit' %}
                <div class="col-md-6">
                    <label class="form-label fw-bold">Date and Time of Recovery</label>
                    <div class="datetime-container">
                        <input type="datetime-local" 
                               name="date_time_recovery" 
                               class="form-control" 
                               step="60"
                               value="{{ form.date_time_recovery.value|default:'' }}">
                    </div>
                    <small class="text-muted">Leave empty if incident is still active</small>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Analysis Section -->
        <div class="form-section">
            <h5><i class="bi bi-search me-2"></i>Analysis Information</h5>
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label fw-bold">Cause</label>
                    <select name="cause" class="form-select">
                        <option value="">--- Select Cause ---</option>
                        {% for config in cause_choices %}
                            <option value="{{ config.value }}">{{ config.value }}</option>
                        {% endfor %}
                    </select>
                    <small class="text-muted">Root cause of the incident (optional)</small>
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-bold">Origin</label>
                    <select name="origin" class="form-select">
                        <option value="">--- Select Origin ---</option>
                        {% for config in origin_choices %}
                            <option value="{{ config.value }}">{{ config.value }}</option>
                        {% endfor %}
                    </select>
                    <small class="text-muted">Source/origin of the incident (optional)</small>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <label class="form-label fw-bold">Impact / Comment</label>
                    <textarea name="impact_comment" class="form-control" rows="4" 
                              placeholder="Describe the impact and any additional comments..."></textarea>
                    <small class="text-muted">Detailed description of the incident impact</small>
                </div>
            </div>
        </div>

        <!-- Submit Section -->
        <div class="row">
            <div class="col-12 text-end">
                <a href="{% url 'incidents:transport_incidents' %}" class="btn btn-outline-secondary me-3">
                    <i class="bi bi-x-lg me-2"></i>Cancel
                </a>
                <button type="submit" class="btn btn-primary btn-submit">
                    <i class="bi bi-check-lg me-2"></i>
                    {% if action == 'Add New' %}Create Incident{% else %}Update Incident{% endif %}
                </button>
            </div>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set current time for new incidents
    {% if action == 'Add New' %}
        const now = new Date();
        const localDateTime = new Date(now.getTime() - (now.getTimezoneOffset() * 60000));
        const incidentTimeInput = document.querySelector('input[name="date_time_incident"]');
        if (incidentTimeInput && !incidentTimeInput.value) {
            incidentTimeInput.value = localDateTime.toISOString().slice(0, 16);
        }
    {% endif %}
    
    function createProfessionalTimeInput() {
        const container = document.createElement('div');
        container.className = 'datetime-input-container';
        
        const displayContainer = document.createElement('div');
        displayContainer.className = 'time-display-container';
        
        // Hours display
        const hoursDisplay = document.createElement('div');
        hoursDisplay.className = 'time-number-display selected';
        hoursDisplay.textContent = '00';
        hoursDisplay.dataset.field = 'hours';
        
        // Separator
        const separator = document.createElement('span');
        separator.className = 'time-separator';
        separator.textContent = ':';
        
        // Minutes display
        const minutesDisplay = document.createElement('div');
        minutesDisplay.className = 'time-number-display';
        minutesDisplay.textContent = '00';
        minutesDisplay.dataset.field = 'minutes';
        
        // Controls
        const controls = document.createElement('div');
        controls.className = 'time-controls';
        
        const upBtn = document.createElement('div');
        upBtn.className = 'time-control-btn up';
        
        const downBtn = document.createElement('div');
        downBtn.className = 'time-control-btn down';
        
        controls.appendChild(upBtn);
        controls.appendChild(downBtn);
        
        // Manual input overlay
        const inputOverlay = document.createElement('div');
        inputOverlay.className = 'time-input-overlay';
        
        const manualInput = document.createElement('input');
        manualInput.className = 'time-manual-input';
        manualInput.placeholder = 'HH:MM';
        manualInput.maxLength = 5;
        
        inputOverlay.appendChild(manualInput);
        
        displayContainer.appendChild(hoursDisplay);
        displayContainer.appendChild(separator);
        displayContainer.appendChild(minutesDisplay);
        
        container.appendChild(displayContainer);
        container.appendChild(controls);
        container.appendChild(inputOverlay);
        
        let selectedField = 'hours';
        let hours = 0;
        let minutes = 0;
        
        // Field selection
        function selectField(field) {
            selectedField = field;
            hoursDisplay.classList.toggle('selected', field === 'hours');
            minutesDisplay.classList.toggle('selected', field === 'minutes');
        }
        
        hoursDisplay.addEventListener('click', () => selectField('hours'));
        minutesDisplay.addEventListener('click', () => selectField('minutes'));
        
        // Spinner controls
        upBtn.addEventListener('click', () => {
            if (selectedField === 'hours') {
                hours = (hours + 1) % 24;
                hoursDisplay.textContent = hours.toString().padStart(2, '0');
            } else {
                minutes = (minutes + 1) % 60;
                minutesDisplay.textContent = minutes.toString().padStart(2, '0');
            }
        });
        
        downBtn.addEventListener('click', () => {
            if (selectedField === 'hours') {
                hours = hours === 0 ? 23 : hours - 1;
                hoursDisplay.textContent = hours.toString().padStart(2, '0');
            } else {
                minutes = minutes === 0 ? 59 : minutes - 1;
                minutesDisplay.textContent = minutes.toString().padStart(2, '0');
            }
        });
        
        // Manual input mode
        container.addEventListener('dblclick', () => {
            inputOverlay.classList.add('active');
            manualInput.value = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
            manualInput.focus();
            manualInput.select();
        });
        
        manualInput.addEventListener('blur', () => {
            const value = manualInput.value;
            const timeRegex = /^([01]?[0-9]|2[0-3]):([0-5][0-9])$/;
            
            if (timeRegex.test(value)) {
                const [h, m] = value.split(':');
                hours = parseInt(h);
                minutes = parseInt(m);
                hoursDisplay.textContent = hours.toString().padStart(2, '0');
                minutesDisplay.textContent = minutes.toString().padStart(2, '0');
            }
            
            inputOverlay.classList.remove('active');
        });
        
        manualInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === 'Escape') {
                manualInput.blur();
            }
        });
        
        // Keyboard support
        container.addEventListener('keydown', (e) => {
            if (inputOverlay.classList.contains('active')) return;
            
            switch(e.key) {
                case 'ArrowUp':
                    e.preventDefault();
                    upBtn.click();
                    break;
                case 'ArrowDown':
                    e.preventDefault();
                    downBtn.click();
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    selectField('hours');
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    selectField('minutes');
                    break;
                case 'Enter':
                    e.preventDefault();
                    container.dispatchEvent(new Event('dblclick'));
                    break;
            }
        });
        
        container.tabIndex = 0;
        
        return {
            container,
            getValue: () => `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`,
            setValue: (timeString) => {
                if (timeString) {
                    const [h, m] = timeString.split(':');
                    hours = parseInt(h) || 0;
                    minutes = parseInt(m) || 0;
                    hoursDisplay.textContent = hours.toString().padStart(2, '0');
                    minutesDisplay.textContent = minutes.toString().padStart(2, '0');
                }
            }
        };
    }
    
    function createUnifiedDateTimeInput(originalInput) {
        const wrapper = document.createElement('div');
        wrapper.className = 'custom-datetime-wrapper';
        
        // Date container
        const dateContainer = document.createElement('div');
        dateContainer.className = 'datetime-input-container';
        
        const dateInput = document.createElement('input');
        dateInput.type = 'date';
        dateInput.className = 'date-input';
        
        dateContainer.appendChild(dateInput);
        
        // Time input
        const timeInput = createProfessionalTimeInput();
        
        wrapper.appendChild(dateContainer);
        wrapper.appendChild(timeInput.container);
        
        function syncValues() {
            if (dateInput.value && timeInput.getValue()) {
                originalInput.value = `${dateInput.value}T${timeInput.getValue()}`;
                originalInput.dispatchEvent(new Event('change', { bubbles: true }));
            }
        }
        
        // Initialize
        if (originalInput.value) {
            const [date, time] = originalInput.value.split('T');
            if (date) dateInput.value = date;
            if (time) timeInput.setValue(time);
        }
        
        // Set current time for incident field
        if (!originalInput.value && originalInput.name === 'date_time_incident') {
            const now = new Date();
            dateInput.value = now.toISOString().split('T')[0];
            timeInput.setValue(`${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`);
            syncValues();
        }
        
        dateInput.addEventListener('change', syncValues);
        timeInput.container.addEventListener('click', syncValues);
        
        originalInput.style.display = 'none';
        originalInput.parentNode.insertBefore(wrapper, originalInput);
        
        if (originalInput.hasAttribute('required')) {
            dateInput.setAttribute('required', '');
        }
        
        return wrapper;
    }
    
    // Apply to all datetime inputs
    document.querySelectorAll('input[type="datetime-local"]').forEach(createUnifiedDateTimeInput);
});
</script>
{% endblock %}